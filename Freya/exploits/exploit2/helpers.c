//
//  helpers.c
//  Odyssey
//
//  Created by tihmstar on 28.06.20.
//  Copyright Â© 2020 coolstar. All rights reserved.
//

#include "helpers.h"

#include <mach/mach.h>
#include <stdlib.h>
#include <stdio.h>

kern_return_t mach_vm_allocate(vm_map_t target, mach_vm_address_t *address, mach_vm_size_t size, int flags);
kern_return_t mach_vm_deallocate(mach_port_name_t target, mach_vm_address_t address, mach_vm_size_t size);
#include <unistd.h>
void suspend_all_threads() {
    thread_act_t other_thread, current_thread;
    unsigned int thread_count;
    thread_act_array_t thread_list;
    
    current_thread = mach_thread_self();

    //usleep(100);

    int result = task_threads(mach_task_self(), &thread_list, &thread_count);
    if (result == -1) {
        sleep(1);
        exit(1);
    }
    if (!result && thread_count) {
        //usleep(1000);

        for (unsigned int i = 0; i < thread_count; ++i) {
            other_thread = thread_list[i];
            if (other_thread != current_thread) {
                usleep(200);
                //printf("usleep suspend_all_threads!\n");
                //sleep(1.5);

                thread_suspend(other_thread);
                //usleep(200);

            }
        }
        //
        //printf("suspend_all_threads!\n");

        //sleep(2);
        //usleep(300);
        mach_vm_deallocate(mach_task_self(), (mach_vm_address_t)thread_list, thread_count*sizeof(mach_port_t));
        //sleep(1);
        
        //printf("So tired sleeping 1 sec ok!\n");

    }
}

void resume_all_threads() {
    thread_act_t other_thread, current_thread;
    unsigned int thread_count;
    thread_act_array_t thread_list;
    
    current_thread = mach_thread_self();
    int result = task_threads(mach_task_self(), &thread_list, &thread_count);
    if (result == -1) {
        sleep(2);
         exit(1);
    }
    if (!result && thread_count) {
        for (unsigned int i = 0; i < thread_count; ++i) {
            other_thread = thread_list[i];
            if (other_thread != current_thread) {
                //printf("usleep resume_all_threads!\n");
                //usleep(1000);
                thread_resume(other_thread);
            }
        }
        //usleep(1000);
        //printf("resume_all_threads!\n");
        //sleep(0.3);
        mach_vm_deallocate(mach_task_self(), (mach_vm_address_t)thread_list, thread_count*sizeof(mach_port_t));
    }
}
